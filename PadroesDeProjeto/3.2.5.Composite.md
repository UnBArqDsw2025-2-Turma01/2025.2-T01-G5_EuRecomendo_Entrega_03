# 3.2.5. Composite

## Introdu√ß√£o

O Composite √© um padr√£o estrutural GoF que permite compor objetos em estruturas de √°rvore para representar hierarquias parte-todo. Na aplica√ß√£o "EuRecomendo", aplicamos este padr√£o para:

**Aplica√ß√£o Principal:** Criar uma estrutura hier√°rquica flex√≠vel para organizar conte√∫do de livros, permitindo que livros individuais e cole√ß√µes de livros (listas de leitura, categorias, cole√ß√µes tem√°ticas) sejam tratados de forma uniforme atrav√©s de uma interface comum.

Vale ressaltar que o padr√£o Composite √© normalmente usado quando:

- Voc√™ precisa representar hierarquias parte-todo de objetos
- Deseja que os clientes tratem objetos individuais e composi√ß√µes de objetos uniformemente
- Precisa criar estruturas de √°rvore complexas com componentes que podem conter outros componentes
- Quer implementar opera√ß√µes que funcionem recursivamente em toda a estrutura hier√°rquica
- Necessita de flexibilidade para adicionar novos tipos de componentes sem modificar c√≥digo existente

## Objetivo

Para a nossa aplica√ß√£o do padr√£o no EuRecomendo:

- Criar uma interface unificada (Component) para livros individuais e cole√ß√µes
- Permitir que listas de leitura contenham livros e outras listas
- Implementar categorias e taxonomias complexas (Fic√ß√£o ‚Üí Fic√ß√£o Cient√≠fica ‚Üí Cyberpunk)
- Facilitar opera√ß√µes uniformes (adicionar, remover, listar) em toda a hierarquia
- Suportar recomenda√ß√µes compostas (livros individuais ou listas inteiras)
- Permitir navega√ß√£o consistente independente do n√≠vel hier√°rquico

## Vantagens

- **Flexibilidade estrutural:** Permite criar estruturas hier√°rquicas complexas de forma natural
- **C√≥digo cliente simplificado:** Cliente trata folhas e composi√ß√µes da mesma forma
- **Princ√≠pio Open/Closed:** F√°cil adicionar novos tipos de componentes sem modificar c√≥digo existente
- **Opera√ß√µes recursivas:** Opera√ß√µes propagam-se automaticamente pela √°rvore
- **Reutiliza√ß√£o:** Componentes podem ser reutilizados em diferentes contextos
- **Manutenibilidade:** Estrutura clara facilita compreens√£o e manuten√ß√£o

## Desvantagens

- **Design gen√©rico demais:** Pode ser dif√≠cil restringir tipos de componentes em composi√ß√µes
- **Complexidade adicional:** Introduz abstra√ß√µes que podem n√£o ser necess√°rias em casos simples
- **Verifica√ß√µes em tempo de execu√ß√£o:** Type system n√£o garante todas as restri√ß√µes
- **Overhead de mem√≥ria:** Objetos compostos mant√™m refer√™ncias a filhos
- **Curva de aprendizado:** Desenvolvedores precisam entender a estrutura recursiva

## Metodologia

Para a realiza√ß√£o deste projeto, adotamos uma abordagem estruturada:

**Ferramentas:**
- VS Code para desenvolvimento
- Django/DRF para implementa√ß√£o do backend
- PostgreSQL para persist√™ncia
- Docker para containeriza√ß√£o
- pytest/Django TestCase para testes
- Draw.io/PlantUML para diagrama√ß√£o

**Processo de Desenvolvimento:**
1. Estudo aprofundado do padr√£o Composite atrav√©s das refer√™ncias bibliogr√°ficas
2. An√°lise dos requisitos do EuRecomendo para identificar estruturas hier√°rquicas
3. Modelagem da hierarquia: BookComponent ‚Üí Leaf (Book) e Composite (BookCollection)
4. Implementa√ß√£o incremental com testes unit√°rios
5. Valida√ß√£o atrav√©s de casos de uso reais
6. Documenta√ß√£o t√©cnica detalhada

**Refer√™ncias:**
- Gamma, E. et al. **Design Patterns: Elements of Reusable Object-Oriented Software**. Addison-Wesley, 1995.
- Refactoring Guru - Composite Pattern: https://refactoring.guru/design-patterns/composite
- Python Design Patterns: https://python3.info/design-patterns/structural/composite.html
- Django REST Framework: https://www.django-rest-framework.org/
- GeeksforGeeks - Composite Pattern: https://www.geeksforgeeks.org/composite-method-python-design-patterns/

O desenvolvimento seguiu abordagem iterativa, come√ßando com estudo te√≥rico profundo do padr√£o, seguido por an√°lise do dom√≠nio do problema, modelagem UML, implementa√ß√£o com TDD, e documenta√ß√£o cont√≠nua dos aprendizados.

## Aplica√ß√£o no EuRecomendo

### C√≥digo

#### Interface BookComponent (backend/books/composite.py)

A interface comum para todos os componentes (livros e cole√ß√µes):

```python
from abc import ABC, abstractmethod
from typing import List, Dict, Optional

class BookComponent(ABC):
    """Interface comum para livros individuais e cole√ß√µes."""
    
    @abstractmethod
    def get_title(self) -> str:
        """Retorna o t√≠tulo do componente."""
        pass
    
    @abstractmethod
    def get_description(self) -> str:
        """Retorna a descri√ß√£o do componente."""
        pass
    
    @abstractmethod
    def get_books_count(self) -> int:
        """Retorna quantidade de livros (1 para livro individual, n para cole√ß√£o)."""
        pass
    
    @abstractmethod
    def display(self, indent: int = 0) -> str:
        """Exibe estrutura hier√°rquica."""
        pass
    
    @abstractmethod
    def to_dict(self) -> Dict:
        """Serializa componente para dicion√°rio."""
        pass
    
    def add(self, component: 'BookComponent') -> None:
        """Adiciona componente filho (s√≥ para Composite)."""
        raise NotImplementedError("Opera√ß√£o n√£o suportada para este componente")
    
    def remove(self, component: 'BookComponent') -> None:
        """Remove componente filho (s√≥ para Composite)."""
        raise NotImplementedError("Opera√ß√£o n√£o suportada para este componente")
    
    def get_child(self, index: int) -> Optional['BookComponent']:
        """Obt√©m componente filho por √≠ndice (s√≥ para Composite)."""
        raise NotImplementedError("Opera√ß√£o n√£o suportada para este componente")
```

**Autores:** Henrique Quenino e Iago Rocha, 2025

#### BookLeaf - Livro Individual (backend/books/composite.py)

Representa um livro individual na estrutura:

```python
class BookLeaf(BookComponent):
    """Representa um livro individual (folha da √°rvore)."""
    
    def __init__(self, book_id: int, title: str, author: str, 
                 description: str = "", isbn: str = "", 
                 categories: List[str] = None):
        self.book_id = book_id
        self.title = title
        self.author = author
        self.description = description
        self.isbn = isbn
        self.categories = categories or []
    
    def get_title(self) -> str:
        return self.title
    
    def get_description(self) -> str:
        return self.description or f"Livro: {self.title} por {self.author}"
    
    def get_books_count(self) -> int:
        return 1
    
    def display(self, indent: int = 0) -> str:
        """Exibe livro individual."""
        prefix = "  " * indent
        return f"{prefix}üìï {self.title} - {self.author}"
    
    def to_dict(self) -> Dict:
        """Serializa livro para JSON."""
        return {
            'type': 'book',
            'id': self.book_id,
            'title': self.title,
            'author': self.author,
            'description': self.description,
            'isbn': self.isbn,
            'categories': self.categories,
            'books_count': 1
        }
```

**Autores:** Henrique Quenino e Iago Rocha, 2025

#### BookCollection - Composite (backend/books/composite.py)

Representa uma cole√ß√£o de livros ou outras cole√ß√µes:

```python
class BookCollection(BookComponent):
    """Representa uma cole√ß√£o de livros ou outras cole√ß√µes (composite)."""
    
    def __init__(self, collection_id: int, name: str, 
                 description: str = "", collection_type: str = "list"):
        self.collection_id = collection_id
        self.name = name
        self.description = description
        self.collection_type = collection_type  # 'list', 'category', 'tag'
        self._children: List[BookComponent] = []
    
    def add(self, component: BookComponent) -> None:
        """Adiciona livro ou subcole√ß√£o."""
        if component not in self._children:
            self._children.append(component)
    
    def remove(self, component: BookComponent) -> None:
        """Remove livro ou subcole√ß√£o."""
        if component in self._children:
            self._children.remove(component)
    
    def get_child(self, index: int) -> Optional[BookComponent]:
        """Obt√©m componente filho por √≠ndice."""
        if 0 <= index < len(self._children):
            return self._children[index]
        return None
    
    def get_children(self) -> List[BookComponent]:
        """Retorna todos os filhos."""
        return self._children.copy()
    
    def get_title(self) -> str:
        return self.name
    
    def get_description(self) -> str:
        return self.description or f"Cole√ß√£o: {self.name}"
    
    def get_books_count(self) -> int:
        """Conta recursivamente todos os livros."""
        total = 0
        for child in self._children:
            total += child.get_books_count()
        return total
    
    def display(self, indent: int = 0) -> str:
        """Exibe estrutura hier√°rquica recursivamente."""
        prefix = "  " * indent
        icon = "üìÅ" if self.collection_type == "category" else "üìö"
        result = f"{prefix}{icon} {self.name} ({self.get_books_count()} livros)\n"
        
        for child in self._children:
            result += child.display(indent + 1) + "\n"
        
        return result.rstrip()
    
    def to_dict(self) -> Dict:
        """Serializa cole√ß√£o e filhos para JSON recursivamente."""
        return {
            'type': 'collection',
            'id': self.collection_id,
            'name': self.name,
            'description': self.description,
            'collection_type': self.collection_type,
            'books_count': self.get_books_count(),
            'children': [child.to_dict() for child in self._children]
        }
    
    def find_by_title(self, title: str) -> List[BookComponent]:
        """Busca recursiva por t√≠tulo."""
        results = []
        for child in self._children:
            if title.lower() in child.get_title().lower():
                results.append(child)
            if isinstance(child, BookCollection):
                results.extend(child.find_by_title(title))
        return results
```

**Autores:** Henrique Quenino e Iago Rocha, 2025

#### Models Django (backend/books/models.py)

Integra√ß√£o com Django ORM:

```python
from django.db import models
from django.contrib.postgres.fields import ArrayField

# Manter o modelo Book existente e adicionar m√©todo to_component
class Book(models.Model):
    """Modelo Django para livros individuais."""
    title = models.CharField(max_length=255)
    author = models.CharField(max_length=255)
    isbn = models.CharField(max_length=20, blank=True)
    description = models.TextField(blank=True)
    categories = ArrayField(
        models.CharField(max_length=100),
        blank=True,
        default=list
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def to_component(self):
        """Converte model Django para BookLeaf (padr√£o Composite)."""
        from .composite import BookLeaf
        return BookLeaf(
            book_id=self.id,
            title=self.title,
            author=self.author,
            description=self.description,
            isbn=self.isbn,
            categories=self.categories if hasattr(self, 'categories') else []
        )
    
    def __str__(self):
        return self.title


# Novo modelo Collection
class Collection(models.Model):
    """Modelo Django para cole√ß√µes de livros."""
    
    COLLECTION_TYPES = [
        ('list', 'Lista de Leitura'),
        ('category', 'Categoria'),
        ('tag', 'Tag'),
        ('recommendation', 'Recomenda√ß√£o')
    ]
    
    name = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    collection_type = models.CharField(
        max_length=20,
        choices=COLLECTION_TYPES,
        default='list'
    )
    parent = models.ForeignKey(
        'self',
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='subcollections'
    )
    books = models.ManyToManyField(Book, related_name='collections', blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def to_component(self):
        """Converte model Django para BookCollection (padr√£o Composite)."""
        from .composite import BookCollection
        
        collection = BookCollection(
            collection_id=self.id,
            name=self.name,
            description=self.description,
            collection_type=self.collection_type
        )
        
        # Adiciona livros
        for book in self.books.all():
            collection.add(book.to_component())
        
        # Adiciona subcole√ß√µes recursivamente
        for subcoll in self.subcollections.all():
            collection.add(subcoll.to_component())
        
        return collection
    
    def get_all_books_recursive(self):
        """Retorna todos os livros incluindo subcole√ß√µes."""
        books = list(self.books.all())
        for subcoll in self.subcollections.all():
            books.extend(subcoll.get_all_books_recursive())
        return books
    
    def __str__(self):
        return f"{self.get_collection_type_display()}: {self.name}"
    
    class Meta:
        ordering = ['name']
```

**Autores:** Henrique Quenino e Iago Rocha, 2025

### Resultados do C√≥digo

#### Exemplo 1: Visualizar Estrutura Hier√°rquica

**Request:**
```bash
GET /api/collections/2/tree_view/
```

**Response: 200 OK**
```json
{
  "tree_display": "üìÅ Fic√ß√£o (5 livros)\n  üìÅ Fic√ß√£o Cient√≠fica (3 livros)\n    üìï Neuromancer - William Gibson\n    üìï Funda√ß√£o - Isaac Asimov\n    üìï 1984 - George Orwell\n  üìï O Senhor dos An√©is - J.R.R. Tolkien\n  üìï Harry Potter - J.K. Rowling",
  "structure": {
    "type": "collection",
    "id": 2,
    "name": "Fic√ß√£o",
    "collection_type": "category",
    "books_count": 5,
    "children": [...]
  }
}
```

#### Exemplo 2: Uso Program√°tico

```python
from books.models import Book, Collection

# Criar estrutura complexa
literature = Collection.objects.create(
    name="Literatura",
    collection_type="category"
)

fiction = Collection.objects.create(
    name="Fic√ß√£o",
    collection_type="category",
    parent=literature
)

scifi = Collection.objects.create(
    name="Fic√ß√£o Cient√≠fica",
    collection_type="category",
    parent=fiction
)

# Adicionar livros
book1 = Book.objects.get(id=1)
book2 = Book.objects.get(id=2)
scifi.books.add(book1, book2)

# Converter para componente Composite
root = literature.to_component()

# Usar interface uniforme
print(f"Total de livros: {root.get_books_count()}")
print(f"Estrutura:\n{root.display()}")

# Buscar recursivamente
results = root.find_by_title("Neuromancer")
for result in results:
    print(f"Encontrado: {result.get_title()}")
```

**Sa√≠da:**
```
Total de livros: 2
Estrutura:
üìÅ Literatura (2 livros)
  üìÅ Fic√ß√£o (2 livros)
    üìÅ Fic√ß√£o Cient√≠fica (2 livros)
      üìï Neuromancer - William Gibson
      üìï Funda√ß√£o - Isaac Asimov
Encontrado: Neuromancer
```

### Passo a Passo para Rodar os C√≥digos

Primeiro deve-se entrar na branch `docs-henrique-e-iago`

#### 1. Subir containers Docker

```bash
cd backend
docker compose up --build -d
```

#### 2. Aplicar migra√ß√µes

```bash
docker compose exec web python manage.py makemigrations books
docker compose exec web python manage.py migrate
```

#### 3. Criar superusu√°rio e testar

```bash
docker compose exec web python manage.py createsuperuser
```

#### 4. Executar testes

```bash
docker compose exec web python manage.py test books.tests.CompositePatternTestCase
```

#### 5. Acessar Django Admin

Acessar: http://localhost:8000/admin para visualizar e gerenciar cole√ß√µes e livros.

### V√≠deo

**V√≠deo 1 - Composite Pattern no EuRecomendo**

[Link do YouTube mostrando a implementa√ß√£o e testes](https://youtu.be/EjfcqpA1gw8)

**Autor/es:** Henrique Quenino e Iago Rocha, 2025

## Bibliografia

- Gamma, E. et al. **Design Patterns: Elements of Reusable Object-Oriented Software**. Addison-Wesley, 1995.
- Refactoring Guru - Composite Pattern: https://refactoring.guru/design-patterns/composite
- Python Design Patterns - Composite: https://python3.info/design-patterns/structural/composite.html
- GeeksforGeeks - Composite Pattern: https://www.geeksforgeeks.org/composite-method-python-design-patterns/
- Wikipedia - Composite Pattern: https://en.wikipedia.org/wiki/Composite_pattern
- Django REST Framework: https://www.django-rest-framework.org/
- Django Documentation: https://docs.djangoproject.com/

## Hist√≥rico de Vers√µes

| Vers√£o | Data | Descri√ß√£o | Autor(es) |
|--------|------|-----------|-----------|
| 0.1 | 24/10/2025 | Cria√ß√£o inicial do documento seguindo padr√£o do Adapter | Henrique Quenino e Iago Rocha |
| 0.2 | 24/10/2025 | Adi√ß√£o de c√≥digo completo e exemplos de uso | Henrique Quenino e Iago Rocha | 
| 1.0 | 24/10/2025 | Vers√£o final com todos os componentes implementados | Henrique Quenino e Iago Rocha |